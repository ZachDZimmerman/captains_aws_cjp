---

- name: Load encrypted default admin password
  include_vars: "default_admin_password.yml"

#this assumes that the `init.groovy.d` directory has been previously created
- name: Update the initialize groovy and copy it to the target directory
  become: true
  template: 
    src: "initial_security.j2"
    dest: "/var/lib/{{ jenkins_user }}/init.groovy.d/000-initial_security.groovy"
    force: yes
    owner: "{{ jenkins_user }}"
    group: "{{ jenkins_user }}"
    mode: u=rw,g=r,o=r   

- name: "get DNS name for {{ terraform_dns_reference }} "
  command: "terraform output -state=../terraform/terraform.tfstate {{ terraform_dns_reference }}"
  delegate_to: localhost
  register: full_dns_name

- name: "Update the set URL groovy ({{ full_dns_name.stdout }}) and copy it to the target directory"
  become: true
  template: 
    src: "set_url.j2"
    dest: "/var/lib/{{ jenkins_user }}/init.groovy.d/002-set_url.groovy"
    force: yes
    owner: "{{ jenkins_user }}"
    group: "{{ jenkins_user }}"
    mode: u=rw,g=r,o=r   

- name: "Copy the JNLP port setting init groovy script"
  become: true
  copy: 
    src: "set-JNLP-port.groovy"
    dest: "/var/lib/{{ jenkins_user }}/init.groovy.d/003-set-JNLP-port.groovy"
    force: yes
    owner: "{{ jenkins_user }}"
    group: "{{ jenkins_user }}"
    mode: u=rw,g=r,o=r   